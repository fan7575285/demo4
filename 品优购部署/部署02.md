# 1. 数据库中间件MyCat

### 问题

单个数据库无法实现海量数据的存储

### 解决

MyCat数据库分片技术,对于开发者来讲,只需要关注业务的处理,数据的分片存储和查询由Mycat处理

### 优点

使用简单,不需要改变之前的使用习惯

![](https://github.com/fudingcheng/teaching-notes/blob/master/diagrams/pinyougou/%E9%83%A8%E7%BD%B2/Mycat%E5%92%8CMysql%E7%9A%84%E5%85%B3%E7%B3%BB.png?raw=true)

### 数据的分片

将数据根据某个特定的规则分散存储到不同的数据库中

### 分片的2种模式

* 垂直切分

​	将不同的表存储到不同的数据库中

* 水平切分

​	将同一个表存储到不同的数据库中

这两种模式可以同时使用

### Mycat的配置

**在schema.xml配置逻辑库**

```xml
<!--逻辑库-->
<schema name="pinyougouDB" checkSQLschema="false" sqlMaxLimit="100">
	<!-- 逻辑表tb_test存储在dn1,dn2,dn3共3个分片,默认的规则为ID值划分 -->
	<table name="tb_test"  dataNode="dn1,dn2,dn3" rule="auto-sharding-long" />
	<table name="tb_order" dataNode="dn1,dn2,dn3" rule="sharding-by-murmur-order" />
</schema>

<!--数据节点-->
<dataNode name="dn1" dataHost="localhost1" database="db1" />
<dataNode name="dn2" dataHost="localhost1" database="db2" />
<dataNode name="dn3" dataHost="localhost1" database="db3" />

<!--节点主机-->
<dataHost name="localhost1" maxCon="1000" minCon="10" balance="0"
	writeType="0" dbType="mysql" dbDriver="native" switchType="1"  slaveThreshold="100">
	<heartbeat>select user()</heartbeat>
	<writeHost host="hostM1" url="192.168.25.131:3306" user="root" password="123456"/>
</dataHost>
```
**在server.xml中配置MyCat的用户名和密码**

```xml
<user name="test">
	<property name="password">test</property>
	<property name="schemas">pinyougouDB</property>
</user>

<user name="root">
	<property name="password">123456</property>
	<property name="schemas">pinyougouDB</property>
</user>
```

### 数据的分片规格介绍

* rang-long:按照ID的范围进行分片
* murmur:将数据均匀分配到每个分片节点上
* [其他规格介绍](https://www.cnblogs.com/leeSmall/p/9462658.html)

###Mycat的分片结构

![](https://github.com/fudingcheng/teaching-notes/blob/master/diagrams/pinyougou/%E9%83%A8%E7%BD%B2/Mycat%E7%9A%84%E6%95%B0%E6%8D%AE%E5%88%86%E7%89%87%E7%AD%96%E7%95%A5.png?raw=true)

### Mycat进行数据库的主从分离

```xml
<dataHost name="localhost1" maxCon="1000" minCon="10" balance="0"
	writeType="0" dbType="mysql" dbDriver="native" switchType="1"  slaveThreshold="100">
	<heartbeat>select user()</heartbeat>
	<writeHost host="hostM1" url="192.168.25.131:3306" user="root" password="123456"/>
</dataHost>
```

![](https://github.com/fudingcheng/teaching-notes/blob/master/diagrams/pinyougou/%E9%83%A8%E7%BD%B2/Mycat%E5%92%8CMysql%E9%9B%86%E6%88%90%E5%AE%9E%E7%8E%B0%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB.png?raw=true)

# 2. Nginx的安装和启动

* 启动

  ```nginx
  ./nginx
  ```

* 关闭

  ```nginx
  ./nginx -s stop
  #或者
  ./nginx -s quit
  ```

* 重启

  ```nginx
  ./nginx -s reload
  ```

# 3. Nginx部署静态网页和配置虚拟主机

### 静态网站配置

```nginx
#80端口
server {
    listen       80;
    server_name  localhost;

    location / {
        root   html/item;				#项目根路径
        index  index.html index.htm;	#默认页面
    }
}
	
#81端口
server {
    listen       81;
    server_name  localhost;

    location / {
        root   html2/item;
        index  index.html index.htm;
    }
}
```

### 域名解析过程

1. 用户输入网址
2. 在本地hosts文件匹配域名对应的IP地址,找到就根据IP地址访问目标服务器
3. 本地hosts文件没有域名对应的IP地址,就从公网DNS服务器继续查找,找到对应IP访问目标服务器
4. 以上都没有匹配到IP地址,浏览器报错!

**一个域名只能对应一个IP地址,一个IP地址(一台计算机)可以被多个域名绑定**

```nginx
#购物车模块
server{
	listen 		80;			   #配置域名后,端口可以设置为80
	server_name cart.pinyougou.com;
	
	location /{
		root  cart;
		index cart.html;
	}
}

#搜索模块
server{
	listen 		80;				#配置域名后,端口可以设置为80
	server_name search.pinyougou.com;		
	
	location /{
		root  search;
		index search.html;
	}
}
```



# 4. Nginx配置反向代理实现负载均衡

### 网络代理的方式

* 正向代理:针对客户端而言,客户端通过代理服务器实现上网/翻墙等功能.
* 反向代理:针对服务器而言,服务器通过反向代理服务器实现请求的负载均衡.

![](https://github.com/fudingcheng/teaching-notes/blob/master/diagrams/pinyougou/%E9%83%A8%E7%BD%B2/%E6%AD%A3%E5%90%91%E4%BB%A3%E7%90%86%E5%92%8C%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86.png?raw=true)

### 网站访问过程

![](https://github.com/fudingcheng/teaching-notes/blob/master/diagrams/pinyougou/%E9%83%A8%E7%BD%B2/%E7%BD%91%E7%AB%99%E8%AE%BF%E9%97%AE%E7%9A%84%E8%BF%87%E7%A8%8B.png?raw=true)

### 反向代理配置

```nginx
server {
	listen    80;
	server_name www.pinyougou.com;
	location / {
		proxy_pass http://tomcat-portal;
		index index.html;
	}
}

#反向代理
upstream tomcat-portal {
	server    192.168.25.131:8081;
	server    192.168.25.131:8082  weight=2;	#该服务器负载的数量时其他2个的2倍
	server    192.168.25.131:8083;
}
```

**Web层的负载均衡通过Nginx的反向代理实现**

**服务层的负载均衡通过Zookeeper的集中配置实现**

### Nginx的高可用

nginx的高可用通过keepalive软件实现

1. 将域名解析到虚拟IP
2. 主服务器提供正常的网络访问
3. 从服务器通过keepalive和主服务器通信进行心跳监测
4. 当检测到主服务器宕机,从服务器自动升级为主服务器

